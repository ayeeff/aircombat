<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Air Combat Power & Analytics</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    
    <style>
        /* Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;900&family=Inter:wght@300;400;500;600;700&display=swap');
        
        /* Global & Globe Specific Styles */
        body { margin: 0; padding: 0; background-color: #000; font-family: 'Inter', sans-serif; overflow-x: hidden; overflow-y: auto; }
        .orbitron { font-family: 'Orbitron', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(15,23,42,0.5); }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 4px; }
        
        /* Globe UI Classes */
        .glass-panel { background: rgba(15,23,42,0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .tab-button { transition: all .3s ease; border-bottom: 2px solid transparent; color: #94a3b8; background: rgba(0,0,0,0.3); white-space: nowrap; }
        .tab-button:hover { background: rgba(59,130,246,0.2); color: #fff; transform: translateY(-2px); }
        .tab-button.active { background: linear-gradient(135deg,rgba(59,130,246,.2),rgba(139,92,246,.2)); border-bottom-color: #3b82f6; color: #60a5fa; box-shadow: 0 0 15px rgba(59,130,246,0.3); }
        
        /* Rank Colors */
        .rank-1 { border-color: rgba(255,215,0,.3); color: #fbbf24; }
        .rank-1.active { background: linear-gradient(135deg,rgba(255,215,0,.2),rgba(218,165,32,.1)); border-bottom-color: #FFD700; color: #fbbf24; }
        .rank-2 { border-color: rgba(192,192,192,.3); }
        .rank-2.active { background: linear-gradient(135deg,rgba(192,192,192,.2),rgba(169,169,169,.1)); border-bottom-color: #C0C0C0; color: #e2e8f0; }
        .rank-3 { border-color: rgba(205,127,50,.3); }
        .rank-3.active { background: linear-gradient(135deg,rgba(205,127,50,.2),rgba(184,115,51,.1)); border-bottom-color: #CD7F32; color: #fdba74; }
        
        .system-glow { box-shadow: 0 0 10px rgba(59,130,246,0.5); border-color: rgba(59,130,246,0.8)!important; }
    </style>
</head>
<body class="text-slate-200">

    <div id="globe-container" class="relative w-full h-screen">
        <div class="absolute top-0 left-0 w-full z-50 flex flex-col pointer-events-none">
            <div class="p-6 pb-2 pointer-events-auto bg-gradient-to-b from-black/90 to-transparent">
                <h1 class="text-3xl font-black orbitron tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 drop-shadow-lg">AIR COMBAT <span class="text-white">GLOBAL</span></h1>
                <p class="text-sm text-slate-400 mt-1 font-mono">Select a nation to analyze F2T2EA Capabilities & Fleet Distribution</p>
                <p class="text-xs text-slate-500 mt-2 animate-bounce">Scroll down for Dashboard &darr;</p>
            </div>
            <div class="w-full overflow-x-auto px-6 py-2 pointer-events-auto no-scrollbar">
                <div id="tabButtons" class="flex flex-nowrap gap-3 pb-2">
                    <div class="animate-pulse flex space-x-4">
                        <div class="h-10 w-32 bg-slate-800 rounded opacity-50"></div>
                        <div class="h-10 w-32 bg-slate-800 rounded opacity-50"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="globeViz" class="w-full h-full bg-slate-900 cursor-move"></div>
        
        <div id="infoBox" class="absolute top-36 right-4 w-96 max-h-[70vh] glass-panel rounded-2xl p-0 transform translate-x-[120%] transition-transform duration-500 ease-out z-40 flex flex-col shadow-2xl overflow-hidden pointer-events-auto">
            <div class="p-5 border-b border-white/10 bg-black/20">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img id="infoFlag" src="" class="w-10 h-auto rounded shadow-sm" alt="Flag">
                        <div>
                            <h2 id="infoCountry" class="text-xl font-bold orbitron text-white leading-none">Country</h2>
                            <span id="infoRank" class="text-xs font-mono text-blue-400">Rank #--</span>
                        </div>
                    </div>
                    <button onclick="closeInfoBox()" class="text-slate-500 hover:text-white transition-colors text-2xl">&times;</button>
                </div>
                <div class="mt-4 flex justify-between items-center bg-white/5 rounded-lg p-2">
                    <div class="text-center">
                        <div class="text-xs text-slate-400">Lethality Index</div>
                        <div id="infoLI" class="text-lg font-bold text-yellow-400 orbitron">0.0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-slate-400">Fleet Size</div>
                        <div id="infoTotal" class="text-lg font-bold text-cyan-400 orbitron">0</div>
                    </div>
                </div>
            </div>
            <div class="overflow-y-auto p-4 space-y-4 custom-scrollbar">
                <div>
                    <h3 class="text-xs font-bold text-purple-400 uppercase tracking-widest mb-2 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-purple-500"></span> Strategic Airports</h3>
                    <div id="infoAirports" class="flex flex-wrap gap-2 text-xs"></div>
                </div>
                <div>
                    <h3 class="text-xs font-bold text-blue-400 uppercase tracking-widest mb-2 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-500"></span> Active Fleet</h3>
                    <div id="infoFleet" class="space-y-2"></div>
                </div>
            </div>
        </div>
        
        <div id="loadingOverlay" class="absolute inset-0 bg-slate-900 z-[60] flex items-center justify-center transition-opacity duration-1000">
            <div class="text-center">
                <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <h2 class="text-2xl font-bold orbitron text-white">INITIALIZING SATELLITE FEED</h2>
                <p class="text-blue-400 font-mono text-sm mt-2">Loading Global Assets...</p>
            </div>
        </div>
    </div>

    <combat-dashboard></combat-dashboard>

    <script type="module">
        import{tableFromIPC}from'https://cdn.jsdelivr.net/npm/apache-arrow@18.0.0/+esm';
        const FEATHER_URL_GLOBAL='https://cdn.jsdelivr.net/gh/ayeeff/aircombat@latest/data/global_merged.feather';
        const FEATHER_URL_CALCS='https://cdn.jsdelivr.net/gh/ayeeff/aircombat@latest/data/calcs.feather';
        const GEOJSON_URL='https://raw.githubusercontent.com/vasturiano/globe.gl/master/example/datasets/ne_110m_admin_0_countries.geojson';
        
        const filenameToCodeMap={'us':'us','rus':'ru','chn':'cn','isr':'il','uk':'gb','aus':'au','jpn':'jp','kor':'kr','swe':'se','ita':'it','fra':'fr','can':'ca','de':'de','tuk':'tr','pk':'pk','thai':'th','spa':'es','iran':'ir','in':'in','sau':'sa'};
        const countriesMeta=[{code:'us',name:'United States',flag:'https://flagcdn.com/w80/us.png'},{code:'ru',name:'Russia',flag:'https://flagcdn.com/w80/ru.png'},{code:'cn',name:'China',flag:'https://flagcdn.com/w80/cn.png'},{code:'il',name:'Israel',flag:'https://flagcdn.com/w80/il.png'},{code:'gb',name:'United Kingdom',flag:'https://flagcdn.com/w80/gb.png'},{code:'au',name:'Australia',flag:'https://flagcdn.com/w80/au.png'},{code:'jp',name:'Japan',flag:'https://flagcdn.com/w80/jp.png'},{code:'kr',name:'South Korea',flag:'https://flagcdn.com/w80/kr.png'},{code:'se',name:'Sweden',flag:'https://flagcdn.com/w80/se.png'},{code:'it',name:'Italy',flag:'https://flagcdn.com/w80/it.png'},{code:'fr',name:'France',flag:'https://flagcdn.com/w80/fr.png'},{code:'ca',name:'Canada',flag:'https://flagcdn.com/w80/ca.png'},{code:'de',name:'Germany',flag:'https://flagcdn.com/w80/de.png'},{code:'tr',name:'Turkey',flag:'https://flagcdn.com/w80/tr.png'},{code:'pk',name:'Pakistan',flag:'https://flagcdn.com/w80/pk.png'},{code:'th',name:'Thailand',flag:'https://flagcdn.com/w80/th.png'},{code:'es',name:'Spain',flag:'https://flagcdn.com/w80/es.png'},{code:'ir',name:'Iran',flag:'https://flagcdn.com/w80/ir.png'},{code:'in',name:'India',flag:'https://flagcdn.com/w80/in.png'},{code:'sa',name:'Saudi Arabia',flag:'https://flagcdn.com/w80/sa.png'}];
        
        let world;
        let fleetData={};
        let calcsData={};
        let geoData=null;
        
        async function loadFeather(url){
            const response=await fetch(url);
            const buffer=await response.arrayBuffer();
            const table=tableFromIPC(buffer);
            return table.toArray().map(row=>row.toJSON())
        }
        
        async function initData(){
            try{
                const geoRes=await fetch(GEOJSON_URL);
                geoData=await geoRes.json();
                
                const globalRows=await loadFeather(FEATHER_URL_GLOBAL);
                globalRows.forEach(row=>{
                    const fileCode=row.country;
                    const code=filenameToCodeMap[fileCode]||fileCode;
                    if(!fleetData[code])fleetData[code]=[];
                    if(row.Aircraft&&row['In Service']){
                        fleetData[code].push(row)
                    }
                });
                
                const calcRows=await loadFeather(FEATHER_URL_CALCS);
                calcRows.forEach(row=>{
                    const cName=row.Country?.trim();
                    const meta=countriesMeta.find(c=>c.name===cName);
                    if(meta){calcsData[meta.code]=row}
                });
                
                countriesMeta.forEach(c=>{
                    c.li=parseFloat(calcsData[c.code]?.LI||0);
                    c.fleetCount=fleetData[c.code]?.reduce((sum,r)=>sum+(parseInt(r['In Service'])||0),0)||0
                });
                
                countriesMeta.sort((a,b)=>b.li-a.li);
                countriesMeta.forEach((c,i)=>c.rank=i+1);
                
                renderTabs();
                initGlobe();
                
                document.getElementById('loadingOverlay').style.opacity='0';
                setTimeout(()=>document.getElementById('loadingOverlay').remove(),1000)
            }catch(err){
                console.error("Critical Init Error:",err);
                alert("Failed to load mission data.")
            }
        }
        
        function renderTabs(){
            const container=document.getElementById('tabButtons');
            let html='';
            countriesMeta.forEach(c=>{
                let rankClass='';
                if(c.rank===1)rankClass='rank-1';
                else if(c.rank===2)rankClass='rank-2';
                else if(c.rank===3)rankClass='rank-3';
                html+=`<button class="tab-button ${rankClass} px-4 py-2 rounded-lg text-sm font-semibold border border-white/5 flex items-center gap-2" data-code="${c.code}" onclick="window.selectCountry('${c.code}')"><img src="${c.flag}" alt="${c.code}" class="w-5 h-4 rounded shadow-sm"><span class="country-name-text hidden md:inline">${c.name}</span><span class="font-mono text-xs opacity-70">#${c.rank}</span></button>`
            });
            container.innerHTML=html
        }
        
        function initGlobe(){
            const elem=document.getElementById('globeViz');
            
            world=Globe()(elem)
                .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
                .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
                .polygonsData(geoData.features.filter(d=>d.properties.ISO_A2!=='AQ'))
                .polygonCapColor(d=>{
                    const meta=countriesMeta.find(c=>c.name===d.properties.NAME||c.name===d.properties.NAME_LONG||c.name===d.properties.ADMIN||(d.properties.ISO_A3==='USA'&&c.code==='us')||(d.properties.ISO_A3==='GBR'&&c.code==='gb')||(d.properties.ISO_A3==='RUS'&&c.code==='ru'));
                    if(meta){
                        const rank=meta.rank;
                        if(rank===1)return'rgba(251, 191, 36, 0.6)';
                        if(rank===2)return'rgba(203, 213, 225, 0.5)';
                        if(rank===3)return'rgba(217, 119, 6, 0.5)';
                        if(rank<=5)return'rgba(59, 130, 246, 0.4)';
                        if(rank<=10)return'rgba(59, 130, 246, 0.3)';
                        if(rank<=15)return'rgba(59, 130, 246, 0.2)';
                        return'rgba(59, 130, 246, 0.15)'
                    }
                    return'rgba(20, 20, 30, 0.1)'
                })
                .polygonSideColor(()=>'rgba(255, 255, 255, 0.02)')
                .polygonStrokeColor(d=>{
                    const meta=countriesMeta.find(c=>c.name===d.properties.NAME||c.name===d.properties.NAME_LONG||c.name===d.properties.ADMIN);
                    if(meta){
                        if(meta.rank===1)return'#fbbf24';
                        if(meta.rank===2)return'#cbd5e1';
                        if(meta.rank===3)return'#f97316';
                        return'#3b82f6'
                    }
                    return'#1a1a2e'
                })
                .polygonLabel(({properties:d})=>`<div class="bg-slate-900/80 backdrop-blur px-2 py-1 rounded text-xs text-white border border-white/10">${d.NAME}</div>`)
                .onPolygonClick(d=>{
                     const meta=countriesMeta.find(c=>c.name===d.properties.NAME||c.name===d.properties.NAME_LONG||c.name===d.properties.ADMIN||(d.properties.ISO_A3==='USA'&&c.code==='us')||(d.properties.ISO_A3==='GBR'&&c.code==='gb')||(d.properties.ISO_A3==='RUS'&&c.code==='ru'));
                    if(meta){window.selectCountry(meta.code)}
                });
                
            world.controls().autoRotate=true;
            world.controls().autoRotateSpeed=0.5;
            world.pointOfView({altitude:2.5});
        }
        
        window.selectCountry=(code)=>{
            const meta=countriesMeta.find(c=>c.code===code);
            if(!meta)return;
            
            document.querySelectorAll('.tab-button').forEach(btn=>{
                btn.classList.remove('active','system-glow');
                if(btn.dataset.code===code)btn.classList.add('active','system-glow')
            });
            
            const coords=getApproxCoords(code);
            world.pointOfView({lat:coords.lat,lng:coords.lng,altitude:1.5},1500);
            world.controls().autoRotate=false;
            populateInfoBox(meta);
        };
        
        window.closeInfoBox=()=>{
            document.getElementById('infoBox').classList.add('translate-x-[120%]');
            world.controls().autoRotate=true;
            document.querySelectorAll('.tab-button').forEach(btn=>btn.classList.remove('active','system-glow'))
        };
        
        function populateInfoBox(meta){
            const box=document.getElementById('infoBox');
            const data=fleetData[meta.code]||[];
            const calc=calcsData[meta.code]||{};
            
            document.getElementById('infoFlag').src=meta.flag;
            document.getElementById('infoCountry').innerText=meta.name;
            document.getElementById('infoRank').innerText=`Global Rank #${meta.rank}`;
            document.getElementById('infoLI').innerText=calc.LI||'N/A';
            document.getElementById('infoTotal').innerText=meta.fleetCount;
            
            const airportSet=new Set();
            data.forEach(row=>{if(row.Airport){row.Airport.split(',').forEach(ap=>airportSet.add(ap.trim()))}});
            const airportsHtml=Array.from(airportSet).map(ap=>`<span class="px-2 py-1 bg-purple-500/10 border border-purple-500/20 text-purple-300 rounded hover:bg-purple-500/20 transition-colors cursor-default">${ap}</span>`).join('');
            document.getElementById('infoAirports').innerHTML=airportsHtml||'<span class="text-slate-500 italic">No airbase data listed</span>';
            
            let fleetHtml='';
            data.forEach(row=>{
                const isManned=row.Manned==='Yes';
                const bgClass=isManned?'bg-blue-500/5 border-blue-500/10':'bg-cyan-500/5 border-cyan-500/10';
                fleetHtml+=`<div class="${bgClass} border rounded p-2 flex items-center gap-3 hover:bg-white/5 transition-colors"><img src="${row.Photo||''}" onerror="this.style.display='none'" class="w-12 h-8 object-cover rounded bg-black/50"><div class="flex-1 min-w-0"><div class="flex justify-between items-center"><span class="font-bold text-white text-sm truncate">${row.Aircraft}</span><span class="text-xs font-bold text-white bg-white/10 px-1 rounded">${row['In Service']}</span></div><div class="flex justify-between items-center mt-1"><span class="text-[10px] text-slate-400 truncate">${row.Type}</span><span class="text-[10px] text-yellow-500/80 truncate max-w-[80px]">${row.Company||'Unknown'}</span></div></div></div>`
            });
            document.getElementById('infoFleet').innerHTML=fleetHtml;
            box.classList.remove('translate-x-[120%]')
        }
        
        function getApproxCoords(code){
            const map={'us':{lat:37.09,lng:-95.71},'ru':{lat:61.52,lng:105.31},'cn':{lat:35.86,lng:104.19},'il':{lat:31.04,lng:34.85},'gb':{lat:55.37,lng:-3.43},'au':{lat:-25.27,lng:133.77},'jp':{lat:36.20,lng:138.25},'kr':{lat:35.90,lng:127.76},'se':{lat:60.12,lng:18.64},'it':{lat:41.87,lng:12.56},'fr':{lat:46.22,lng:2.21},'ca':{lat:56.13,lng:-106.34},'de':{lat:51.16,lng:10.45},'tr':{lat:38.96,lng:35.24},'pk':{lat:30.37,lng:69.34},'th':{lat:15.87,lng:100.99},'es':{lat:40.46,lng:-3.74},'in':{lat:20.59,lng:78.96},'sa':{lat:23.88,lng:45.07},'ir':{lat:32.42,lng:53.68}};
            return map[code]||{lat:0,lng:0}
        }
        
        initData();
    </script>

    <script type="module">
        import { tableFromIPC } from 'https://cdn.jsdelivr.net/npm/apache-arrow@18.0.0/+esm';

        // Helper to load feather from within the component
        async function loadFeather(url) {
            const response = await fetch(url);
            const buffer = await response.arrayBuffer();
            const table = tableFromIPC(buffer);
            return table.toArray().map(row => row.toJSON());
        }

        class CombatDashboard extends HTMLElement {
            constructor() {
                super();
                this.attachShadow({ mode: 'open' });
                this.fleetData = {};
                this.calcsData = {};
                this.productsData = {};
                this.companiesData = {};
                this.activeTab = 'us';
                
                this.countries = [{code:'us',name:'United States',flag:'https://flagcdn.com/w80/us.png'},{code:'ru',name:'Russia',flag:'https://flagcdn.com/w80/ru.png'},{code:'cn',name:'China',flag:'https://flagcdn.com/w80/cn.png'},{code:'il',name:'Israel',flag:'https://flagcdn.com/w80/il.png'},{code:'gb',name:'United Kingdom',flag:'https://flagcdn.com/w80/gb.png'},{code:'au',name:'Australia',flag:'https://flagcdn.com/w80/au.png'},{code:'jp',name:'Japan',flag:'https://flagcdn.com/w80/jp.png'},{code:'kr',name:'South Korea',flag:'https://flagcdn.com/w80/kr.png'},{code:'se',name:'Sweden',flag:'https://flagcdn.com/w80/se.png'},{code:'it',name:'Italy',flag:'https://flagcdn.com/w80/it.png'},{code:'fr',name:'France',flag:'https://flagcdn.com/w80/fr.png'},{code:'ca',name:'Canada',flag:'https://flagcdn.com/w80/ca.png'},{code:'de',name:'Germany',flag:'https://flagcdn.com/w80/de.png'},{code:'tr',name:'Turkey',flag:'https://flagcdn.com/w80/tr.png'},{code:'pk',name:'Pakistan',flag:'https://flagcdn.com/w80/pk.png'},{code:'th',name:'Thailand',flag:'https://flagcdn.com/w80/th.png'},{code:'es',name:'Spain',flag:'https://flagcdn.com/w80/es.png'},{code:'ir',name:'Iran',flag:'https://flagcdn.com/w80/ir.png'},{code:'in',name:'India',flag:'https://flagcdn.com/w80/in.png'},{code:'sa',name:'Saudi Arabia',flag:'https://flagcdn.com/w80/sa.png'}];

                this.filenameToCodeMap = {
                    'us': 'us', 'rus': 'ru', 'chn': 'cn', 'isr': 'il', 'uk': 'gb',
                    'aus': 'au', 'jpn': 'jp', 'kor': 'kr', 'swe': 'se', 'ita': 'it',
                    'fra': 'fr', 'can': 'ca', 'de': 'de', 'tuk': 'tr', 'pk': 'pk',
                    'thai': 'th', 'spa': 'es', 'iran': 'ir', 'in': 'in', 'sau': 'sa'
                };

                this.subsystemLabels={A:{name:'Sensor Reach',weight:'22.5%',color:'blue',tooltip:'AESA raw detection range vs. 3 m² target, plus off-board cue quality (AEW/sat-links).'},B:{name:'Signature Control',weight:'15%',color:'purple',tooltip:'Frontal RCS, IR-suppression, passive EW suite.'},C:{name:'Missile Reach',weight:'22.5%',color:'red',tooltip:'Published / leaked aerodynamic range of primary BVR weapon, plus Pk at NEZ.'},D:{name:'Kill-Chain Network',weight:'15%',color:'green',tooltip:'Secure L-16-style datalink, AEW density, ground-radar gap-filler coverage, sat-feed.'},E:{name:'ECM / Self-Protection',weight:'10%',color:'orange',tooltip:'On-board jammer, towed decoy, MAWS, expendable count.'},F:{name:'Sustained Sortie Rate',weight:'5%',color:'cyan',tooltip:'Crew ratio, hot-pit refuel, local MRO, spares pool.'},G:{name:'UCAV/Drone Production',weight:'10%',color:'pink',tooltip:'Mass production volume of unmanned combat aerial vehicles, loitering munitions, and collaborative combat aircraft.'}};
            }

            connectedCallback() {
                this.renderInitialStructure();
                this.init();
                
                // Expose methods to window for the generated HTML inline events to call
                // But bind them to this instance
                window.dashboardInstance = this;
            }
            
            // Methods called by inline HTML events
            switchToTab(cc) { 
                this.activeTab = cc;
                this.shadowRoot.querySelectorAll('.tab-button').forEach(btn=>{
                    btn.classList.remove('active','system-glow');
                    if(btn.dataset.countryCode===cc) btn.classList.add('active');
                });
                this.clearSystemHighlight();
                this.renderTabContent(cc);
                this.updatePerformancePanel(cc);
                this.highlightSystemButtons(cc);
            }
            
            showCoreModal(system) {
                const matchingCountries=this.countries.filter(c=>{const calc=this.calcsData[c.code];return calc&&calc.Core&&calc.Core.toLowerCase().includes(system.toLowerCase());}).sort((a,b)=>a.rank-b.rank);
                this.shadowRoot.getElementById('modalTitle').textContent=`${system.toUpperCase()} Core System`;
                this.shadowRoot.getElementById('liRow').innerHTML=this.renderLIRow(matchingCountries);
                this.populateModalContent(matchingCountries);
                this.openModal('coreModal');
            }
            
            showGuidanceModal(system) {
                 const matchingCountries=this.countries.filter(c=>{const calc=this.calcsData[c.code];return calc&&calc.Guidance&&calc.Guidance.toLowerCase()===system.toLowerCase();}).sort((a,b)=>a.rank-b.rank);
                 this.shadowRoot.getElementById('modalTitle').textContent=`${system.toUpperCase()} Guidance System`;
                 this.shadowRoot.getElementById('liRow').innerHTML=this.renderLIRow(matchingCountries);
                 this.populateModalContent(matchingCountries);
                 this.openModal('coreModal');
            }
            
            showProductModal(name) {
                const product = this.productsData[name];
                let html = '';
                if (!product) html = '<p class="text-red-400">Product details not found.</p>';
                else {
                    html = `<h3 class="text-lg font-bold text-white mb-2">${product.Product || name}</h3>`;
                    Object.keys(product).forEach(key => { if (key !== 'Product' && product[key]) html += `<p class="text-sm"><strong>${key}:</strong> ${product[key]}</p>`; });
                }
                this.shadowRoot.getElementById('productModalContent').innerHTML = html;
                this.shadowRoot.getElementById('productModalTitle').textContent = name;
                this.openModal('productModal');
            }
            
            showCompanyModal(name) {
                const company = this.companiesData[name];
                let html = '';
                if (!company) html = '<p class="text-red-400">Company details not found.</p>';
                else {
                     html = `<h3 class="text-lg font-bold text-white mb-2">${company.Company || name}</h3>`;
                     Object.keys(company).forEach(key => { if (key !== 'Company' && company[key]) html += `<p class="text-sm"><strong>${key}:</strong> ${company[key]}</p>`; });
                }
                this.shadowRoot.getElementById('companyModalContent').innerHTML = html;
                this.shadowRoot.getElementById('companyModalTitle').textContent = name;
                this.openModal('companyModal');
            }
            
            showAirportModal(name) {
                 const cc = this.activeTab;
                 const aircraft = this.fleetData[cc] || [];
                 const filtered = aircraft.filter(ac => ac.Aircraft && ac['Airport'] && ac['Airport'].split(',').some(ap => ap.trim() === name));
                 let totalCount = 0; filtered.forEach(ac => totalCount += parseInt(ac['In Service']) || 0);
                 
                 let html = `<div class="text-center mb-4"><div class="text-2xl font-bold text-white">${totalCount}</div><p class="text-sm text-slate-400">Total Aircraft at ${name}</p></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;
                 filtered.forEach(ac => {
                    const style = ac.Manned === 'Yes' ? 'manned-mini' : 'unmanned-mini';
                    html += `<div class="airport-mini-card ${style} p-4 rounded-lg"><img src="${ac.Photo || 'https://via.placeholder.com/300x200?text=No+Image'}" class="w-full h-32 object-cover rounded-lg mb-2"><h4 class="text-lg font-bold text-white mb-1">${ac.Aircraft}</h4><p class="text-sm text-slate-300"><strong>Type:</strong> ${ac.Type}</p><p class="text-sm font-bold text-white"><strong>In Service:</strong> ${ac['In Service']}</p></div>`;
                 });
                 html += '</div>';
                 this.shadowRoot.getElementById('airportModalContent').innerHTML = html;
                 this.shadowRoot.getElementById('airportModalTitle').textContent = name;
                 this.openModal('airportModal');
            }

            openModal(id) {
                const modal = this.shadowRoot.getElementById(id);
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('show'), 10);
            }
            
            closeModal(id) {
                 const modal = this.shadowRoot.getElementById(id);
                 modal.classList.remove('show');
                 setTimeout(() => modal.classList.add('hidden'), 300);
            }

            renderInitialStructure() {
                const styles = `
                /* Static Tailwind for Shadow DOM */
                @import url('https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css');
                @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;900&family=Inter:wght@300;400;500;600;700&display=swap');
                
                :host { display: block; background: linear-gradient(135deg,rgba(15,23,42,1) 0%,rgba(30,41,59,1) 50%,rgba(12,30,61,1) 100%); position: relative; min-height: 100vh; overflow: hidden; font-family: 'Inter', sans-serif; }
                .orbitron{font-family:'Orbitron',sans-serif}.country-name-text{color:#fff!important} 
                .cyber-grid{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(90deg,rgba(59,130,246,.03) 1px,transparent 1px),linear-gradient(180deg,rgba(59,130,246,.03) 1px,transparent 1px);background-size:50px 50px;z-index:0;animation:gridScroll 20s linear infinite;pointer-events:none} @keyframes gridScroll{0%{transform:translateY(0)}100%{transform:translateY(50px)}} 
                .tab-button{transition:all .3s ease;border-bottom:3px solid transparent;color:#94a3b8} .tab-button.active{background:linear-gradient(135deg,rgba(59,130,246,.2),rgba(139,92,246,.2));border-bottom-color:#3b82f6;color:#60a5fa} .tab-button:hover:not(.active){background:rgba(255,255,255,.05);color:#cbd5e1} 
                .tab-button.rank-1{background:linear-gradient(135deg,rgba(255,215,0,.3),rgba(218,165,32,.2));border-color:rgba(255,215,0,.5)} .tab-button.rank-1.active{background:linear-gradient(135deg,rgba(255,215,0,.4),rgba(218,165,32,.3));border-bottom-color:#FFD700} 
                .tab-button.rank-2{background:linear-gradient(135deg,rgba(192,192,192,.3),rgba(169,169,169,.2));border-color:rgba(192,192,192,.5)} .tab-button.rank-2.active{background:linear-gradient(135deg,rgba(192,192,192,.4),rgba(169,169,169,.3));border-bottom-color:#C0C0C0} 
                .tab-button.rank-3{background:linear-gradient(135deg,rgba(205,127,50,.3),rgba(184,115,51,.2));border-color:rgba(205,127,50,.5)} .tab-button.rank-3.active{background:linear-gradient(135deg,rgba(205,127,50,.4),rgba(184,115,51,.3));border-bottom-color:#CD7F32} 
                .tab-button.system-glow{background:rgba(59,130,246,.35)!important;box-shadow:0 0 30px rgba(59,130,246,.6);border-color:rgba(59,130,246,.8)!important} 
                .aircraft-card{background:linear-gradient(135deg,rgba(255,255,255,.08) 0%,rgba(255,255,255,.02) 100%);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.1);transition:all .3s ease} 
                .manned-card{background:linear-gradient(135deg,rgba(0,31,63,.2) 0%,rgba(0,31,63,.1) 100%) !important;} .unmanned-card{background:linear-gradient(135deg,rgba(135,206,235,.2) 0%,rgba(135,206,235,.1) 100%) !important;} .aircraft-card:hover{transform:translateY(-4px);box-shadow:0 20px 40px rgba(0,0,0,.3);border-color:rgba(59,130,246,.5)} 
                .speed-card{background:linear-gradient(135deg,rgba(255,255,255,.08) 0%,rgba(255,255,255,.02) 100%);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.1);transition:all .4s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden} .speed-card::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);transition:left .6s} .speed-card:hover::before{left:100%} .speed-card:hover{transform:translateY(-2px);box-shadow:0 25px 50px rgba(0,0,0,.4);border-color:rgba(255,255,255,.3)} 
                .shimmer-text{background:linear-gradient(90deg,#fff 0%,#60a5fa 50%,#fff 100%);background-size:1000px 100%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimmer 3s linear infinite} @keyframes shimmer{0%{background-position:-1000px 0}100%{background-position:1000px 0}} 
                .info-icon{cursor:help;display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;border-radius:50%;background:rgba(59,130,246,.2);border:1px solid rgba(59,130,246,.4);font-size:10px;font-weight:700;color:#60a5fa;transition:all .2s ease} .info-icon:hover{background:rgba(59,130,246,.3);border-color:rgba(59,130,246,.6);transform:scale(1.1)} .info-icon-wide{width:18px;height:18px;font-size:12px} .tooltip{position:relative;z-index:99999 !important} .tooltip-text{visibility:hidden;opacity:0;position:absolute;left:calc(100% + 10px);top:50%;transform:translateY(-50%);background:linear-gradient(135deg,rgba(30,41,59,.98),rgba(15,23,42,.98));color:#e2e8f0;padding:10px 14px;border-radius:8px;font-size:12px;width:140px;max-width:140px;z-index:99999 !important;border:1px solid rgba(59,130,246,.3);box-shadow:0 10px 25px rgba(0,0,0,.5);transition:all .3s ease;pointer-events:none;line-height:1.4;white-space:normal;} .tooltip:hover .tooltip-text{visibility:visible;opacity:1} .tooltip-text::before{content:'';position:absolute;left:-6px;top:50%;transform:translateY(-50%);border:6px solid transparent;border-right-color:rgba(30,41,59,.98)} .tooltip-left .tooltip-text{left:auto;right:calc(100% + 10px);} .tooltip-left .tooltip-text::before{left:auto;right:-6px;border-right-color:transparent;border-left-color:rgba(30,41,59,.98)} 
                .core-badge { background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(139,92,246,0.2)); border: 1px solid rgba(59,130,246,0.4); color: #60a5fa; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; } .core-badge:hover { background: linear-gradient(135deg, rgba(59,130,246,0.3), rgba(139,92,246,0.3)); border-color: #3b82f6; transform: scale(1.05); box-shadow: 0 0 10px rgba(59,130,246,0.4); } 
                .multi-vendor-penalty { background: linear-gradient(135deg, rgba(239,68,68,0.3), rgba(220,38,38,0.2)); border: 1px solid rgba(239,68,68,0.5); color: #fca5a5; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; animation: pulse 2s infinite; display: inline-flex; align-items: center; } .multi-vendor-penalty:hover { background: linear-gradient(135deg, rgba(239,68,68,0.4), rgba(220,38,38,0.3)); border-color: #ef4444; transform: scale(1.05); } @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } } 
                #coreModal, #productModal, #companyModal, #airportModal { opacity: 0; transform: translateY(20px); transition: all 0.3s ease; } .show { opacity: 1 !important; transform: translateY(0) !important; } .modal-overlay { animation: fadeIn 0.3s ease; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } } 
                .li-row { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: flex-start; align-items: center; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); overflow-x: auto; } .li-card { flex: 0 0 auto; min-width: 80px; text-align: center; } .li-score-card { background: linear-gradient(to right, rgba(234,179,8,0.2), rgba(251,191,36,0.2)); border: 1px solid rgba(234,179,8,0.4); padding: 8px; border-radius: 8px; } .li-score { font-size: 1.25rem; font-weight: bold; color: #fbbf24; font-family: 'Orbitron', sans-serif; } .li-flag { width: 20px; height: 15px; margin-top: 4px; border-radius: 2px; } .li-country-li { background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02)); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); padding: 6px 10px; border-radius: 6px; margin: 1px; font-size: 10px; color: #e2e8f0; min-width: 120px; } .country-li-badge { display: inline-flex; align-items: center; gap: 0.5rem; background: linear-gradient(to right, rgba(234,179,8,0.2), rgba(251,191,36,0.2)); border: 1px solid rgba(234,179,8,0.4); color: #fbbf24; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; font-family: 'Orbitron', sans-serif; white-space: nowrap; } .li-header { text-align: center; margin-bottom: 1rem; } .li-header h3 { color: #fbbf24; font-family: 'Orbitron', sans-serif; font-size: 1.25rem; font-weight: bold; } 
                .product-button { background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(16,185,129,0.2)); border: 1px solid rgba(34,197,94,0.4); color: #10b981; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; margin: 2px; display: inline-flex; align-items: center; } .product-button:hover { background: linear-gradient(135deg, rgba(34,197,94,0.3), rgba(16,185,129,0.3)); border-color: #10b981; transform: scale(1.05); box-shadow: 0 0 8px rgba(34,197,94,0.4); } .company-button { background: linear-gradient(135deg, rgba(234,179,8,0.2), rgba(251,191,36,0.2)); border: 1px solid rgba(234,179,8,0.4); color: #fbbf24; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; margin: 2px; display: inline-flex; align-items: center; } .company-button:hover { background: linear-gradient(135deg, rgba(234,179,8,0.3), rgba(251,191,36,0.3)); border-color: #fbbf24; transform: scale(1.05); box-shadow: 0 0 8px rgba(234,179,8,0.4); } .airport-button { background: linear-gradient(135deg, rgba(168,85,247,0.2), rgba(139,92,246,0.2)); border: 1px solid rgba(168,85,247,0.4); color: #a855f7; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; margin: 2px; display: inline-flex; align-items: center; } .airport-button:hover { background: linear-gradient(135deg, rgba(168,85,247,0.3), rgba(139,92,246,0.3)); border-color: #a855f7; transform: scale(1.05); box-shadow: 0 0 8px rgba(168,85,247,0.4); } .airport-mini-card { background: linear-gradient(135deg, rgba(255,255,255,.08) 0%, rgba(255,255,255,.02) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,.1); transition: all .3s ease; } .airport-mini-card.manned-mini { background: linear-gradient(135deg, rgba(0,31,63,.2) 0%, rgba(0,31,63,.1) 100%) !important; } .airport-mini-card.unmanned-mini { background: linear-gradient(135deg, rgba(135,206,235,.2) 0%, rgba(135,206,235,.1) 100%) !important; } .airport-mini-card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,.3); border-color: rgba(168,85,247,.5); }
                `;

                this.shadowRoot.innerHTML = `
                <style>${styles}</style>
                <div class="cyber-grid"></div>
                <div class="relative z-10 max-w-[1800px] mx-auto p-4 md:p-8">
                    <div class="text-center mb-8">
                        <h1 class="text-4xl md:text-6xl font-black mb-2 orbitron bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent shimmer-text">AIR COMBAT POWER DASHBOARD</h1>
                        <p class="text-lg md:text-xl text-slate-300">Beyond Visual Range (Find, Fix, Track, Target, Engage, Assess) F2T2EA System Kill Chain Analysis</p>
                    </div>
                    <div id="loading" class="text-center py-20">
                        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                        <p class="text-slate-400">Loading fleet data...</p>
                    </div>
                    <div id="mainContent" class="hidden">
                        <div id="tabButtons" class="flex flex-wrap gap-2 mb-6 speed-card p-4 rounded-xl"></div>
                        <div class="grid grid-cols-1 lg:grid-cols-[55%_45%] gap-6">
                            <div id="fleetContent">
                                <div id="tabContent" class="min-h-screen"></div>
                            </div>
                            <div>
                                <div class="sticky top-4">
                                    <div class="speed-card rounded-2xl p-6 mb-6" id="countryPerformance">
                                        <div class="flex items-center justify-between mb-4">
                                            <div class="flex items-center gap-4">
                                                <img id="perfFlag" src="" alt="" class="w-16 h-10 flag-badge rounded-lg">
                                                <h2 id="perfCountryName" class="text-2xl font-bold orbitron country-name-text">United States</h2>
                                                <p id="perfRank" class="text-slate-400">Rank #1</p>
                                            </div>
                                            <div class="text-right flex items-center gap-2">
                                                <span class="text-sm text-cyan-400 font-semibold">Core System:</span>
                                                <div id="perfCoreContainer" class="flex flex-wrap gap-1 items-center"></div>
                                            </div>
                                        </div>
                                        <div class="text-right flex items-center gap-2 mt-2">
                                            <span class="text-sm text-cyan-400 font-semibold">Guidance System:</span>
                                            <div id="perfGuidanceContainer" class="flex flex-wrap gap-1 items-center"></div>
                                        </div>
                                        <div id="perfSellsSection" class="text-right flex items-center gap-2 mt-2" style="display: none;">
                                            <span class="text-sm text-cyan-400 font-semibold">Sells System to:</span>
                                            <div id="perfSellsContainer" class="flex flex-wrap gap-1 items-center"></div>
                                        </div>
                                        <div id="perfBuysSection" class="text-right flex items-center gap-2 mt-2" style="display: none;">
                                            <span class="text-sm text-cyan-400 font-semibold">Buys System from:</span>
                                            <div id="perfBuysContainer" class="flex flex-wrap gap-1 items-center"></div>
                                        </div>
                                        <div id="perfContext" class="mb-6 p-4 bg-gradient-to-br from-slate-700/40 to-slate-800/40 rounded-lg border border-slate-600/30">
                                            <div class="text-sm text-slate-300 leading-relaxed">
                                                <span class="text-yellow-400 font-semibold">Context:</span> In a contemporary air war scenario (120+ Jets India vs. Pakistan, May 2025), combat is no longer fought in ace-pilot dogfights à la Top Gun or Ace Combat; instead, engagements are decided beyond visual range using BVR weapons, AWACS/AEW radar networks, and a F2T2EA kill chain.
                                            </div>
                                        </div>
                                        <div id="sidebarMetrics" class="grid grid-cols-[60%_40%] gap-4"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="coreModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
                    <div class="absolute inset-0 bg-black bg-opacity-50 modal-overlay" onclick="window.dashboardInstance.closeModal('coreModal')"></div>
                    <div class="relative bg-gradient-to-br from-slate-800/90 to-slate-900/90 backdrop-blur-md rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto border border-slate-600/30">
                        <div class="flex justify-between items-center mb-6 sticky top-0 bg-inherit z-10">
                            <h2 id="modalTitle" class="text-2xl md:text-3xl font-black orbitron text-white"></h2>
                            <button class="text-slate-400 hover:text-white text-3xl" onclick="window.dashboardInstance.closeModal('coreModal')">×</button>
                        </div>
                        <div id="liRow" class="mb-6"></div>
                        <div id="modalContent" class="space-y-6"></div>
                    </div>
                </div>
                <div id="productModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
                    <div class="absolute inset-0 bg-black bg-opacity-50 modal-overlay" onclick="window.dashboardInstance.closeModal('productModal')"></div>
                    <div class="relative bg-gradient-to-br from-slate-800/90 to-slate-900/90 backdrop-blur-md rounded-2xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto border border-slate-600/30">
                        <div class="flex justify-between items-center mb-6 sticky top-0 bg-inherit z-10">
                            <h2 id="productModalTitle" class="text-2xl md:text-3xl font-black orbitron text-white"></h2>
                            <button class="text-slate-400 hover:text-white text-3xl" onclick="window.dashboardInstance.closeModal('productModal')">×</button>
                        </div>
                        <div id="productModalContent" class="space-y-4 text-slate-300 leading-relaxed"></div>
                    </div>
                </div>
                <div id="companyModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
                    <div class="absolute inset-0 bg-black bg-opacity-50 modal-overlay" onclick="window.dashboardInstance.closeModal('companyModal')"></div>
                    <div class="relative bg-gradient-to-br from-slate-800/90 to-slate-900/90 backdrop-blur-md rounded-2xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto border border-slate-600/30">
                        <div class="flex justify-between items-center mb-6 sticky top-0 bg-inherit z-10">
                            <h2 id="companyModalTitle" class="text-2xl md:text-3xl font-black orbitron text-white"></h2>
                            <button class="text-slate-400 hover:text-white text-3xl" onclick="window.dashboardInstance.closeModal('companyModal')">×</button>
                        </div>
                        <div id="companyModalContent" class="space-y-4 text-slate-300 leading-relaxed"></div>
                    </div>
                </div>
                <div id="airportModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
                    <div class="absolute inset-0 bg-black bg-opacity-50 modal-overlay" onclick="window.dashboardInstance.closeModal('airportModal')"></div>
                    <div class="relative bg-gradient-to-br from-slate-800/90 to-slate-900/90 backdrop-blur-md rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto border border-slate-600/30">
                        <div class="flex justify-between items-center mb-6 sticky top-0 bg-inherit z-10">
                            <h2 id="airportModalTitle" class="text-2xl md:text-3xl font-black orbitron text-white"></h2>
                            <button class="text-slate-400 hover:text-white text-3xl" onclick="window.dashboardInstance.closeModal('airportModal')">×</button>
                        </div>
                        <div id="airportModalContent" class="space-y-6"></div>
                    </div>
                </div>
                `;
            }

            async init() {
                try {
                    await this.loadGlobalFleetData();
                    const cData = await loadFeather('https://cdn.jsdelivr.net/gh/ayeeff/aircombat@latest/data/calcs.feather');
                    cData.forEach(row => {
                        const countryName = row.Country?.trim();
                        if (countryName) {
                            const countryObj = this.countries.find(c => c.name === countryName);
                            if (countryObj) this.calcsData[countryObj.code] = row;
                        }
                    });

                    const pData = await loadFeather('https://cdn.jsdelivr.net/gh/ayeeff/aircombat@latest/data/products.feather');
                    pData.forEach(row => { if (row.Product) this.productsData[row.Product.trim()] = row; });

                    const coData = await loadFeather('https://cdn.jsdelivr.net/gh/ayeeff/aircombat@latest/data/company.feather');
                    coData.forEach(row => { if (row.Company) this.companiesData[row.Company.trim()] = row; });

                    this.countries.sort((a,b)=>parseFloat(this.calcsData[b.code]?.LI||0)-parseFloat(this.calcsData[a.code]?.LI||0));
                    this.countries.forEach((c,i)=>c.rank=i+1);

                    this.shadowRoot.getElementById('loading').classList.add('hidden');
                    this.shadowRoot.getElementById('mainContent').classList.remove('hidden');
                    
                    this.createTabs();
                    this.renderTabContent('us');
                    this.updatePerformancePanel('us');
                } catch (error) {
                    console.error('Error initializing dashboard:', error);
                    this.shadowRoot.getElementById('loading').innerHTML=`<div class="text-center"><p class="text-red-400 mb-4">Error loading data</p><p class="text-slate-400 text-sm">${error.message}</p></div>`;
                }
            }

            async loadGlobalFleetData() {
                const url = 'https://cdn.jsdelivr.net/gh/ayeeff/aircombat@latest/data/global_merged.feather';
                const allRows = await loadFeather(url);
                this.fleetData = {};
                allRows.forEach(row => {
                    const fileCountry = row.country; 
                    const frontendCode = this.filenameToCodeMap[fileCountry] || fileCountry;
                    if (!this.fleetData[frontendCode]) this.fleetData[frontendCode] = [];
                    if (row.Aircraft && row['In Service']) this.fleetData[frontendCode].push(row);
                });
            }

            createTabs() {
                const container = this.shadowRoot.getElementById('tabButtons');
                let html = '';
                this.countries.forEach((country,i) => {
                    const calcData = this.calcsData[country.code] || {};
                    const rankClass = i < 3 ? `rank-${i+1}` : '';
                    html+=`<button class="tab-button ${rankClass} px-6 py-3 rounded-lg text-sm font-semibold ${country.code===this.activeTab?'active':''}" data-country-code="${country.code}" onclick="window.dashboardInstance.switchToTab('${country.code}')"><img src="${country.flag}" alt="${country.code}" class="w-5 h-4 inline-block mr-2 rounded"><span class="country-name-text">${country.name}</span><span class="ml-2 text-xs opacity-75">#${country.rank}</span></button>`;
                });
                container.innerHTML = html;
            }

            renderTabContent(cc) {
                const country=this.countries.find(c=>c.code===cc);
                const aircraft=this.fleetData[cc]||[];
                const calcData=this.calcsData[cc]||{};
                const tabContent=this.shadowRoot.getElementById('tabContent');
                
                const subsystemHTML=Object.keys(this.subsystemLabels).map(key=>{
                    const info=this.subsystemLabels[key];
                    const value=parseInt(calcData[key])||0;
                    return `<div class="p-3 bg-gradient-to-br from-slate-700/40 to-slate-800/40 rounded-lg border border-slate-600/30"><div class="flex items-center gap-2 mb-1"><span class="text-xs text-${info.color}-400 font-semibold flex items-center gap-1">${key}. ${info.name}<span class="tooltip"><span class="info-icon">?</span><span class="tooltip-text">${info.tooltip}</span></span></span></div><div class="text-2xl font-black orbitron text-white">${value}</div></div>`;
                }).join('');
                
                const liTooltip="The Lethality Index represents the system lethality of this nation's air force in Beyond Visual Range combat, factoring in the best available aircraft mix, missile capability, sensor reach, and network integration.";
                
                tabContent.innerHTML=`<div class="aircraft-card rounded-2xl p-4 md:p-6 mb-6"><h3 class="text-xl font-bold orbitron mb-4 country-name-text">Sub-System Performance</h3><div class="grid grid-cols-4 md:grid-cols-8 gap-2">${subsystemHTML}<div class="p-3 bg-gradient-to-r from-yellow-500/20 to-orange-500/20 rounded-lg border border-yellow-500/30"><div class="flex items-center gap-1 mb-1"><span class="text-xs text-yellow-400 font-semibold flex items-center gap-1">Lethality Index<span class="tooltip tooltip-left"><span class="info-icon info-icon-wide">?</span><span class="tooltip-text">${liTooltip}</span></span></span></div><div class="text-2xl font-black orbitron text-yellow-400">${calcData.LI||'0'}</div></div></div></div><div class="grid grid-cols-1 gap-4 md:gap-6">${aircraft.map((ac)=>{
                    if(!ac.Aircraft)return '';
                    const bvrKillChain = ac['BVR kill chain'] || '';
                    const associatedProducts = (ac['Associated products'] || '').split(',').map(p => p.trim()).filter(p => p);
                    const airports = (ac['Airport'] || '').split(',').map(ap => ap.trim()).filter(ap => ap);
                    const company = ac.Company || ac.Origin || 'Unknown';
                    const origin = ac.Origin || 'Unknown';
                    const originCountry = this.countries.find(c => c.name.toLowerCase() === origin.toLowerCase());
                    const flag = originCountry ? originCountry.flag : '';
                    const mannedClass = ac.Manned === 'Yes' ? 'manned-card' : 'unmanned-card';
                    
                    const productsHtml = associatedProducts.length > 0 ? `<div class="mt-3"><span class="text-xs text-green-400 font-semibold mb-1 block">Associated Products:</span><div class="flex flex-wrap gap-1">${associatedProducts.map(product => `<span class="product-button text-white" onclick="window.dashboardInstance.showProductModal('${product}')">${product}</span>`).join('')}</div></div>` : '';
                    const companyHtml = `<span class="company-button" onclick="window.dashboardInstance.showCompanyModal('${company}')"><img src="${flag}" class="w-4 h-3 inline-block mr-1 rounded">${company}</span>`;
                    const airportHtml = airports.length > 0 ? airports.map(airport => `<span class="airport-button text-white" onclick="window.dashboardInstance.showAirportModal('${airport}')">${airport}</span>`).join('') : '';
                    const companyAirportsSection = `<div class="mt-3 flex flex-wrap items-start gap-4"><div class="flex items-center gap-2"><span class="text-xs text-yellow-400 font-semibold">Company:</span>${companyHtml}</div><div class="flex items-center gap-2"><span class="text-xs text-purple-400 font-semibold">Airports:</span><div class="flex flex-wrap gap-1">${airportHtml}</div></div></div>`;
                    
                    return `<div class="aircraft-card ${mannedClass} rounded-xl md:rounded-2xl overflow-hidden p-4 md:p-6"><div class="grid grid-cols-1 md:grid-cols-10 gap-4"><div class="md:col-span-3 flex flex-col"><img src="${ac.Photo||'https://via.placeholder.com/400x300?text=No+Image'}" alt="${ac.Aircraft}" class="w-full h-48 md:h-64 object-cover rounded-lg" loading="lazy" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'"><h3 class="text-xl md:text-2xl font-bold mt-3 orbitron country-name-text">${ac.Aircraft}</h3></div><div class="md:col-span-5"><div class="text-sm text-blue-400 font-semibold mb-1">BVR F2T2EA Kill Chain</div><p class="text-slate-300 leading-relaxed text-sm md:text-base">${bvrKillChain}</p>${companyAirportsSection}${productsHtml}</div><div class="md:col-span-2 space-y-2"><div class="p-2 bg-gradient-to-br from-blue-500/20 to-blue-600/20 rounded-lg border border-blue-500/30"><div class="text-xs text-blue-400 font-semibold mb-1">Type</div><div class="text-xs text-white">${ac.Type}</div></div><div class="p-2 bg-gradient-to-br from-purple-500/20 to-purple-600/20 rounded-lg border border-purple-500/30"><div class="text-xs text-purple-400 font-semibold mb-1">Origin</div><div class="text-xs text-white">${ac.Origin}</div></div><div class="p-2 bg-gradient-to-br from-green-500/20 to-green-600/20 rounded-lg border border-green-500/30"><div class="text-xs text-green-400 font-semibold mb-1">Version</div><div class="text-xs text-white">${ac.Versions}</div></div><div class="p-2 bg-gradient-to-br from-yellow-500/20 to-yellow-600/20 rounded-lg border border-yellow-500/30"><div class="text-xs text-yellow-400 font-semibold mb-1">In Service</div><div class="text-sm text-white font-bold">${ac['In Service']}</div></div></div></div></div>`;
                }).join('')}</div>`;
            }

            updatePerformancePanel(cc) {
                const country=this.countries.find(c=>c.code===cc);
                const calcData=this.calcsData[cc]||{};
                this.shadowRoot.getElementById('perfFlag').src=country.flag;
                this.shadowRoot.getElementById('perfCountryName').textContent=country.name;
                this.shadowRoot.getElementById('perfRank').textContent=`Rank #${country.rank}`;
                
                const coreStr=calcData.Core||'';
                const coreParts = coreStr.split('-').filter(part => part.trim() !== '');
                let coreHtml = coreParts.map(core=>`<span class="core-badge text-sm font-semibold orbitron" onclick="window.dashboardInstance.showCoreModal('${core}')">${core}</span>`).join(' ');
                if (coreParts.length >= 4) { coreHtml += '<span class="multi-vendor-penalty">Multi Vendor Penalty</span>';}
                this.shadowRoot.getElementById('perfCoreContainer').innerHTML=coreHtml;
                
                const guidanceStr=calcData.Guidance||'';
                this.shadowRoot.getElementById('perfGuidanceContainer').innerHTML=`<span class="core-badge text-base font-bold orbitron" onclick="window.dashboardInstance.showGuidanceModal('${guidanceStr}')">${guidanceStr}</span>`;
                
                const sellStr = calcData.Sell || '';
                const sellCountries = sellStr ? sellStr.split('-').map(s => s.trim()).filter(Boolean) : [];
                let sellsHtml = '';
                sellCountries.forEach(s => { 
                    const matchedCountry = this.countries.find(c => c.name.toLowerCase().includes(s.toLowerCase())); 
                    if (matchedCountry) { sellsHtml += `<span class="core-badge text-base font-bold orbitron" onclick="window.dashboardInstance.switchToTab('${matchedCountry.code}')"><img src="${matchedCountry.flag}" alt="${matchedCountry.code}" class="w-4 h-3 inline-block mr-1 rounded"><span class="ml-1">${matchedCountry.code.toUpperCase()}</span></span>`; } 
                    else { sellsHtml += `<span class="core-badge text-base font-bold orbitron">${s}</span>`; }
                });
                this.shadowRoot.getElementById('perfSellsContainer').innerHTML = sellsHtml;
                this.shadowRoot.getElementById('perfSellsSection').style.display = sellCountries.length > 0 ? 'flex' : 'none';

                const buyStr = calcData.Buy || '';
                const buyCountries = buyStr ? buyStr.split('-').map(b => b.trim()).filter(Boolean) : [];
                let buysHtml = '';
                buyCountries.forEach(b => { 
                    const matchedCountry = this.countries.find(c => c.name.toLowerCase().includes(b.toLowerCase())); 
                    if (matchedCountry) { buysHtml += `<span class="core-badge text-base font-bold orbitron" onclick="window.dashboardInstance.switchToTab('${matchedCountry.code}')"><img src="${matchedCountry.flag}" alt="${matchedCountry.code}" class="w-4 h-3 inline-block mr-1 rounded"><span class="ml-1">${matchedCountry.code.toUpperCase()}</span></span>`; } 
                    else { buysHtml += `<span class="core-badge text-base font-bold orbitron">${b}</span>`; }
                });
                this.shadowRoot.getElementById('perfBuysContainer').innerHTML = buysHtml;
                this.shadowRoot.getElementById('perfBuysSection').style.display = buyCountries.length > 0 ? 'flex' : 'none';

                const aircraft=this.fleetData[cc]||[];
                const typeMap={}; let totalInService=0;
                aircraft.forEach(ac=>{
                    if(ac.Aircraft&&ac.Type&&ac['In Service']){
                        const type=ac.Type; const inService=parseInt(ac['In Service'])||0; totalInService+=inService;
                        if(!typeMap[type]){typeMap[type]={versions:[],total:0};}
                        typeMap[type].versions.push(ac.Versions||'N/A'); typeMap[type].total+=inService;
                    }
                });
                
                const productSet = new Set();
                aircraft.forEach(ac => {
                    const associatedProducts = (ac['Associated products'] || '').split(',').map(p => p.trim()).filter(p => p);
                    associatedProducts.forEach(p => productSet.add(p));
                });
                const productsHtml = Array.from(productSet).map(p => `<span class="product-button text-white" onclick="window.dashboardInstance.showProductModal('${p}')">${p}</span>`).join('');
                
                let groupedCompanies = {};
                aircraft.forEach(ac => {
                    let comp = ac.Company || ac.Origin || 'Unknown';
                    if (comp !== 'Unknown') {
                        let origin = this.companiesData[comp]?.Origin || ac.Origin || 'Domestic';
                        if (!groupedCompanies[origin]) {groupedCompanies[origin] = new Set();}
                        groupedCompanies[origin].add(comp);
                    }
                });
                
                let allCompanies = [];
                Object.entries(groupedCompanies).forEach(([origin, set]) => { 
                    const originCountry = this.countries.find(c => c.name.toLowerCase() === origin.toLowerCase()); 
                    const flag = originCountry ? originCountry.flag : ''; 
                    set.forEach(comp => { allCompanies.push({comp, flag}); });
                });
                const companiesHtml = `<div class="flex flex-wrap gap-1">${allCompanies.sort((a,b)=>a.comp.localeCompare(b.comp)).map(({comp, flag}) => `<span class="company-button" onclick="window.dashboardInstance.showCompanyModal('${comp}')"><img src="${flag}" class="w-4 h-3 inline-block mr-1 rounded">${comp}</span>`).join('')}</div>`;

                const typeHTML=Object.keys(typeMap).map(type=>{
                    const info=typeMap[type];
                    return `<div class="p-2 bg-gradient-to-br from-slate-700/30 to-slate-800/30 rounded-lg border border-slate-600/30"><div class="text-xs text-blue-400 font-semibold mb-1">${type}</div><div class="text-xs text-slate-300 mb-1">Version(s): ${info.versions.join(', ')}</div><div class="text-xs text-white font-bold">Total: ${info.total}</div></div>`;
                }).join('');
                
                this.shadowRoot.getElementById('sidebarMetrics').innerHTML=`<div><div class="grid grid-cols-2 gap-2 mb-3"><div class="p-2 bg-gradient-to-br from-red-500/20 to-red-600/20 rounded-lg border border-red-500/30"><div class="text-xs text-red-400 mb-1 font-semibold">BVR Missile Range (km)</div><div class="text-xs font-bold text-white">${calcData.BVR||'N/A'}</div></div><div class="p-2 bg-gradient-to-br from-purple-500/20 to-purple-600/20 rounded-lg border border-purple-500/30"><div class="text-xs text-purple-400 mb-1 font-semibold">AEW Range (km)</div><div class="text-xs font-bold text-white">${calcData.AEW||'N/A'}</div></div></div><div class="space-y-3 mt-4"><div><span class="text-xs text-green-400 font-semibold mb-1 block">Companies:</span>${companiesHtml}</div><div><span class="text-xs text-green-400 font-semibold mb-1 block">Associated Products:</span><div class="flex flex-wrap gap-1">${productsHtml}</div></div></div><div class="space-y-2 mt-4"><div class="p-2 bg-gradient-to-br from-orange-500/10 to-orange-600/10 rounded-lg border border-orange-500/20"><div class="text-xs text-orange-400 mb-1 font-semibold uppercase">Missile Design and Performance</div><div class="text-xs text-slate-300 leading-relaxed">${calcData['Missile Design and Performance']||'N/A'}</div></div><div class="p-2 bg-gradient-to-br from-pink-500/10 to-pink-600/10 rounded-lg border border-pink-500/20"><div class="text-xs text-pink-400 mb-1 font-semibold uppercase">Platform Integration</div><div class="text-xs text-slate-300 leading-relaxed">${calcData['Platform Integration']||'N/A'}</div></div><div class="p-2 bg-gradient-to-br from-indigo-500/10 to-indigo-600/10 rounded-lg border border-indigo-500/20"><div class="text-xs text-indigo-400 mb-1 font-semibold uppercase">Cueing and Detection</div><div class="text-xs text-slate-300 leading-relaxed">${calcData['Cueing and Detection']||'N/A'}</div></div></div></div><div><div class="mb-3 p-3 bg-gradient-to-br from-cyan-500/20 to-cyan-600/20 rounded-lg border border-cyan-500/30"><div class="text-xs text-cyan-400 mb-1 font-semibold">Country Total Aircraft</div><div class="text-2xl font-black orbitron text-cyan-300">${totalInService}</div></div><div class="space-y-2">${typeHTML}</div></div>`;
            }

            highlightSystemButtons(cc){
                const calcData=this.calcsData[cc];
                if(!calcData||!calcData.Core)return;
                const coreSystem=calcData.Core.toLowerCase();
                const coreKeywords=coreSystem.split('-');
                const hasNATO=coreKeywords.includes('nato');
                const primarySystem=coreKeywords[0];
                this.shadowRoot.querySelectorAll('.tab-button').forEach(btn=>{
                    const btnCode=btn.dataset.countryCode;
                    const btnCalcData=this.calcsData[btnCode];
                    if(btnCalcData&&btnCalcData.Core){
                        const btnCore=btnCalcData.Core.toLowerCase();
                        const btnKeywords=btnCore.split('-');
                        const btnHasNATO=btnKeywords.includes('nato');
                        const btnPrimarySystem=btnKeywords[0];
                        if(btnCore===coreSystem||btnKeywords.includes(primarySystem)||coreKeywords.includes(btnPrimarySystem)||(hasNATO&&btnHasNATO)){
                            btn.classList.add('system-glow');
                        }
                    }
                });
            }

            clearSystemHighlight(){
                this.shadowRoot.querySelectorAll('.tab-button').forEach(btn=>{btn.classList.remove('system-glow');});
            }

            renderLIRow(matchingCountries) {
                const sortedCountries = [...matchingCountries].sort((a, b) => parseFloat(this.calcsData[b.code]?.LI || 0) - parseFloat(this.calcsData[a.code]?.LI || 0));
                const liTooltip = "The Lethality Index represents the system lethality of this nation's air force in Beyond Visual Range combat.";
                let html = `<div class="li-header"><h3>Lethality Index Ranking <span class="tooltip tooltip-left"><span class="info-icon info-icon-wide">?</span><span class="tooltip-text">${liTooltip}</span></span></h3></div><div class="li-row">`;
                sortedCountries.forEach(country => {
                    const li = this.calcsData[country.code]?.LI || '0';
                    html += `<div class="li-card"><div class="li-score-card"><div class="li-score">${li}</div><img src="${country.flag}" alt="${country.name}" class="li-flag"></div></div>`;
                });
                html += '</div>';
                return html;
            }
            
            populateModalContent(matchingCountries) {
                 const content=this.shadowRoot.getElementById('modalContent');
                 let html='';
                 matchingCountries.forEach(country=>{
                    const calc=this.calcsData[country.code];
                    const li=calc?.LI||'0';
                    const aircraft=this.fleetData[country.code]||[];
                    let total=0; const typeMap={};
                    aircraft.forEach(ac=>{if(ac['In Service']){const ins=parseInt(ac['In Service'])||0;total+=ins;const type=ac.Type||'Unknown';if(!typeMap[type]){typeMap[type]={total:0,variants:new Set()};}typeMap[type].total+=ins;if(ac.Versions)typeMap[type].variants.add(ac.Versions);}});
                    const metricSquares=`<div class="flex flex-wrap gap-1 mb-4"><span class="li-country-li"><strong>BVR Missile (km):</strong><br>${calc.BVR||'N/A'}</span><span class="li-country-li"><strong>AEW / Ground Cue (km):</strong><br>${calc.AEW||'N/A'}</span><span class="li-country-li"><strong>BVR System (km):</strong><br>${calc['BVR limit km']||'N/A'}</span></div>`;
                    html+=`<div class="p-4 bg-gradient-to-br from-slate-700/40 to-slate-800/40 rounded-lg border border-slate-600/30"><div class="flex items-center justify-between mb-4"><div class="flex items-center gap-4"><img src="${country.flag}" alt="${country.name}" class="w-12 h-8 rounded-lg flag-badge"><div class="flex items-center gap-2"><div><h3 class="text-xl font-bold text-white">${country.name}</h3><p class="text-sm text-slate-400">#${country.rank}</p></div><span class="country-li-badge">Lethality Index Score: ${li}</span></div></div><div class="text-right"><div class="text-2xl font-black orbitron text-cyan-300">${total}</div><p class="text-xs text-slate-400">Total Aircraft</p></div></div>${metricSquares}<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${Object.keys(typeMap).map(type=>`<div class="p-3 bg-gradient-to-br from-blue-500/10 to-blue-600/10 rounded-lg border border-blue-500/20"><div class="text-sm font-semibold text-blue-300 mb-2">${type}</div><div class="text-xs text-slate-300 mb-2">Variants: ${Array.from(typeMap[type].variants).join(', ')}</div><div class="text-lg font-bold text-white">${typeMap[type].total}</div></div>`).join('')}</div></div>`;
                 });
                 content.innerHTML=html;
            }
        }
        customElements.define('combat-dashboard', CombatDashboard);
    </script>
</body>
</html>
